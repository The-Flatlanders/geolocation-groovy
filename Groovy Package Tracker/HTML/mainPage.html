<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en">
<head>
	<title>Package Tracker</title>
	<script type="text/javascript">
		//makes UUIDs the default tab
		if (document.location.hash == "" || document.location.hash == "#")
			document.location.hash = "#UUIDtab";
	</script>
	<link rel="stylesheet" type="text/css" href="MainStyleSheet.css">
</head>
<body onload="addPackage()">
	<script language=javascript>
		console.log(document.login.cookie);
		if(getCookie("username")==""){
			//window.location="login.html";
		}
		function getCookie(cname) {
          var name = cname + "=";
          var ca = document.cookie.split(';');
          for(var i=0; i<ca.length; i++) {
              var c = ca[i];
              while (c.charAt(0)==' ') c = c.substring(1);
              if (c.indexOf(name) == 0) return c.substring(name.length,c.length);
          }
          return "";
		}
	</script>
	<div id="controlPanel">
		<div class = "tabs">
			<div id="UUIDtab"> <a href="#UUIDtab">UUID</a>
				<div id="form">
					Package UUID:<br/><input id="uuid" type="text" name="uuid"><br/>
					<input type="button" value="Submit uuid" onclick="addPackage()">
				</div>
			</div>
			<div id="AccountTab"> <a href="#AccountTab">Account</a>
				<div>
					<input type="button" value="Logout" onclick="logout()">
				</div>
			</div>
			<div id="DetailTab"> <a href="#DetailTab">Details</a>
				<div id ="details">
				</div>
			</div>
		</div>
	</div>
	<div id="map">
	</div>
	<script type="text/javascript">
		var map;
		function initMap(center) {
        map = new google.maps.Map(document.getElementById('map'), {
          center: center,
          zoom: 8
        });
		}
		function showPackage(myPackage){
		  	var myLatLng = {lat: myPackage.location.lat, lng: myPackage.location.lon};
			var marker = new google.maps.Marker({
				    position: myLatLng,
				    map: map,
				    title: 'Hello World!'
			});
			
			var bounds = map.getBounds();
			bounds.extend(marker.getPosition());
			map.fitBounds(bounds);
			
			if(map.getZoom() > 14){
				  map.setZoom(14);
			}
			
			marker.addListener('click', function(){
				  console.log(myPackage);
				  document.getElementById('details').innerHTML=
					  "ETA: "+myPackage.eta+" hours\n"+
					  "Distance: "+myPackage.distanceFromDestination+" meters\n";
			});
		}
        </script>
	<script async defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCh8IK9eDqqGB8Wx2k0Vr_pcisZD1qw74A&callback=initMap">
	</script>
	<script language="javascript">
		//TODO: Fix this shoddiness
		function logout(){
			var xmlHttp = new XMLHttpRequest();
          xmlHttp.open( "GET", "http://localhost:8000/logout/", false ); // false for synchronous request
          xmlHttp.send( null );
			window.location = "Login.html";
		}
	</script>
	<script language="javascript">//unnessessary language identifier?
		
		//TODO: Can we call the utility function here?
			
		xmlhttp=new XMLHttpRequest();	
		function addPackage()
		{
			var packageList;
			xmlhttp.onreadystatechange=
			function()
			{			
				if(xmlhttp.readyState ==4&& xmlhttp.status==200)
				{
					packageList=JSON.parse(xmlhttp.responseText);
					var packageLocations=[];
					packageList.forEach(
						function(currentPackage) { 
						    packageLocations.push(currentPackage.location);
						});
					//call midpoint function here with params packageLocations
					initMap(findMidpoint(packageLocations));
					packageList.forEach(
						function(currentPackage) { 
							showPackage(currentPackage);
						});
				}else{
				}
			}		
			var params = "uuid="+document.getElementById('uuid').value;
			xmlhttp.open("POST", "http://localhost:8000/addPackage",true);
			xmlhttp.setRequestHeader("Content-type", "application/x-www-form-urlencoded");
			xmlhttp.setRequestHeader("Content-length", params.length);
			xmlhttp.setRequestHeader("Connection", "close");
			xmlhttp.setRequestHeader("Access-Control-Allow-Origin","*");
			xmlhttp.send(params);
		}
  </script>
	<script language="javascript">
		function findMidpoint(positions){
		var leftEdge = 180; //lon
    		var rightEdge = -180; //lon
		var topEdge = -90; //lat
		var bottomEdge = 90; //lat
       		
      for(var i = 0; i < positions.length; i++){
    		var lat = positions[i].lat;
        	var lon = positions[i].lon;
        	if(lat < bottomEdge){
        		bottomEdge = lat;
        	}
        	if(lat > topEdge){
        		topEdge = lat;
        	}
        	if(lon < leftEdge){
        		leftEdge = lon;
       		}
        	if(lon > rightEdge){
        		rightEdge = lon;
        	}
      }
      var midLat=(topEdge + bottomEdge) / 2;
      var midLon=(rightEdge + leftEdge) / 2;
      return {lat:midLat,lng:midLon};
  }
  </script>
</body>
</html>
