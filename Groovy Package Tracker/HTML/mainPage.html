<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en">
<head>
<title>Package Tracker</title>
<script>
         //makes UUIDs the default tab
         if (document.location.hash == "" || document.location.hash == "#")
         	document.location.hash = "#UUIDtab";
      </script>
<script src=serverPostRequest.js></script>
<link rel="stylesheet" type="text/css" href="MainStyleSheet.css" />
</head>
<body onload="showMyPackages()">
	<div id="controlPanel">
		<div class="tabs">
			<div id="UUIDtab">
				<a href="#UUIDtab">UUID</a>
				<div id="form">
					Package UUID:<br /> <input id="uuid" type="text" name="uuid" /><br />
					<input type="button" value="Submit uuid" onclick="addPackage()" />
				</div>
				
			</div>
			<div id="AccountTab">
				<a href="#AccountTab">Account</a>
				<div>
					<input type="button" value="Logout" onclick="logout()">
					<div id="trackedPackages"></div>
				</div>
				
			</div>
			<div id="DetailTab">
				<a href="#DetailTab">Details</a>
				<div>
					<div id="notes">
						UUID: <input type="text" id="notesInputUUID" name="notesInputUUID"><br>
						Notes: <input type="text" id="notesInput" name="notesInput"><br>
						<input type="button" value="Submit Notes" onclick="addNotes()"/>
						<br>
					</div>
					<div id="details"></div>
				</div>
			</div>
		</div>
	</div>
	<div id="map"></div>
	<script type="text/javascript">
         var map;
         var noPackagesYet = true;
         var deleteOnReclick = [];
         var allMarkers = [];
         var activePackage;
         function initMap() {
               map = new google.maps.Map(document.getElementById('map'), {
                 center: {lat:0,lng:0},
                 zoom: 2
               });
         }
         function sizeMap(){
        		 var bounds = new google.maps.LatLngBounds();
        		 for(i=0;i<allMarkers.length;i++) {
        		    bounds.extend(allMarkers[i].getPosition());
        		 }

        		 map.setCenter(bounds.getCenter());
        		 map.fitBounds(bounds);
        		 map.setZoom(map.getZoom()-1); 
        		 if(map.getZoom()> 10){
        		   map.setZoom(10);
        		 }
         }
         function deleteMapObjects(){
        	 for(var i = 0; i < deleteOnReclick.length; i++){
      			for(var j = 0; j < allMarkers.length; j++){
      				if(allMarkers[j] == deleteOnReclick[i]){
      					allMarkers.splice(j,1);
      				}
      			}
      			deleteOnReclick[i].setMap(null);
      		}
				deleteOnReclick.length = 0;
         }
         function getCurrentPackage(){
        	 return currentPackage;
         }
         function showPackage(myPackage){
           	var myLatLng = {lat: myPackage.location.lat, lng: myPackage.location.lon};
         	var marker = new google.maps.Marker({
         		    position: myLatLng,
         		    map: map,
         		    title: myPackage.uuid
         	});
         	
         	allMarkers.push(marker);
         	sizeMap();
         	
         	var location;
         	var geocoder=new google.maps.Geocoder();
         	geocoder.geocode({'location': myLatLng}, function(results, status) {
         			if (status === google.maps.GeocoderStatus.OK) {
         					if (results[1]) {
         						location=(results[1].formatted_address);
         					} else {
           					console.log('No results found');
         					}
         		} else {
         			location="Unknown or unpopulated area"
         					console.log('Geocoder failed due to: ' + status);
         		}
         	});
         	
         	
         	marker.addListener('click', function(){
         		activePackage = myPackage;
         		window.location="#DetailTab";
         		var html;
         		//myPackage.notes = "happened";
         		if(myPackage.delivered){
         			html="Delivered";
         		}else{
         			html="UUID: "+myPackage.uuid+"<br>ETA: "+Math.round(myPackage.eta * 100) / 100+" hours"+"<br>"+
         			"Distance: "+(Math.round(myPackage.distanceFromDestination/10) / 100)+" Km"+"<br>"+
         			"Current Location: "+location+"<br><br><br>Notes:<br>"+myPackage.notes;
         		}
         		 	document.getElementById('details').innerHTML=html;
         		 	document.getElementById('notesInputUUID').value=myPackage.uuid;
         	});
         	
         	marker.addListener('click', function(){
         		deleteMapObjects();

         		var pastCords = myPackage.pastCords;
         		for (var i = 0; i < pastCords.length - 1; i++) {
         			var cord1 = pastCords[i];
                   	var cord2 = pastCords[i + 1];
         			var latlong1 = {lat: cord1.lat, lng: cord1.lon};
                   	var latlong2 = {lat: cord2.lat, lng: cord2.lon};
                   	
                   	var polyline = new google.maps.Polyline({
                   	    path:[latlong1,latlong2],
                   		strokeColor: '#FF0000',
                   	    strokeOpacity: 1.0,
                   	    strokeWeight: 10,
                   	    map: map
                   	});
                   	deleteOnReclick.push(polyline); 
         		}
         		
         		var green = 'green-dot.png';
                var start = new google.maps.Marker({
                  position: {lat: myPackage.startingLocation.lat, lng: myPackage.startingLocation.lon},
                  map: map,
                  icon: green
                });
                
                var blue = 'blue-dot.png';
                var end = new google.maps.Marker({
                  position: {lat: myPackage.destination.lat, lng: myPackage.destination.lon},
                  map: map,
                  icon: blue
                });
                
               	deleteOnReclick.push(start);
               	deleteOnReclick.push(end); 

               	allMarkers.push(start);
               	allMarkers.push(end);

         		sizeMap();
         		
         	});
         }
      </script>
	<script async defer
		src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCh8IK9eDqqGB8Wx2k0Vr_pcisZD1qw74A&callback=initMap"></script>
	<script>
         function logout(){
         	execHttpRequest("GET","http://localhost:8000/logout",false,"",function(){
         		window.location = "Login.html";
         	})
         }
         window.onunload = "logout()";
      </script>
	<script type="text/javascript">	
         xmlhttp=new XMLHttpRequest();	
         function addPackage()
         {
         	var params = "uuid="+document.getElementById('uuid').value;
         	execHttpRequest("POST","http://localhost:8000/addPackage",true,params,function(responseText){showMyPackages()});
         }
      </script>
	<script type="text/javascript">
		 var packages;
         function showMyPackages()
         {
         	execHttpRequest("POST","http://localhost:8000/packages",true,"",function(responseText){
         		if(responseText == "noUser"){
         			window.location = "Login.html"
         		}
         		console.log(responseText);
         		var packageList=JSON.parse(responseText);
         		var packageLocations=[];
         		packageList.forEach(function(currentPackage) { 
         			packageLocations.push(currentPackage.location);
         		});
         		initMap();
         		packageList.forEach(function(currentPackage) { 
         			showPackage(currentPackage);
         			console.log("currentPackage");
         			userPackages.push(currentPackage.uuid);
        		});
         		document.getElementById('trackedPackages').innerHtml=userPackages.toString();
         		console.log(userPackages);
         	});
         }
         //TODO: Make notes persist over refreshes (they are currently stored on the userside, but not the serverside)
         function addNotes(){		
         			if(confirm("Are you sure? This will over write any current notes on this package.")){
						getCurrentPackage().notes = document.getElementById('notesInput').value;
						document.getElementById('notesInput').value = "";
					}
		}
      </script>
</body>
</html>
